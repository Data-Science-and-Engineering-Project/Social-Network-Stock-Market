# 📈 רשת חברתית לשוק המניות - Stock Market Social Network

## מטרת הפרויקט
**יעד:** לחזות אילו מניות קרן השקעות עתידה לקנות ברבעון הבא, באמצעות למידת מכונה מתקדמת מבוססת גרפים. המערכת מיועדת לחיזוי חזק, בלתי מוטה ועל מדגם חיצוני, עם מניעה קפדנית של דליפת נתונים/זמן.

---

## הסבר ארוך ופשוט על הפייפליין: איך אנחנו חוזים השקעות עתידיות של קרנות בשוק המניות

שלום! אני הולך להסביר לך את הפייפליין בצורה ארוכה ומפורטת, אבל פשוטה מאוד, כאילו אני מסביר לחבר שמעולם לא ראה קוד. המטרה היא שתוכל להעביר את זה למשקיעים בצורה קלה, עם דוגמאות יומיומיות, כדי להראות איך המערכת עובדת, למה היא חכמה, ואיך היא נותנת יתרון תחרותי.

הפייפליין הזה הוא בעצם "מכונה" שמבוססת על בינה מלאכותית (AI) ולמידת מכונה (Machine Learning), שמנתחת נתוני השקעות מקרנות כדי לחזות אילו מניות הן יקנו ברבעון הבא. הרעיון המרכזי: שוק המניות הוא כמו רשת חברתית גדולה – קרנות "חברות" זו של זו אם הן מחזיקות במניות דומות, ואנחנו משתמשים בזה כדי לזהות דפוסים.

### שלב 1: הכנת הנתונים (Data Loading and Cleaning)
**מה קורה כאן?**  
אנחנו טוענים נתונים מקבצי CSV (כמו טבלאות Excel) שמכילים מידע על החזקות של קרנות השקעות בכל רבעון. כל קובץ כולל פרטים כמו: CIK (מזהה של הקרן), CUSIP (מזהה של המניה), VALUE (כמה כסף מושקע), SSHPRNAMT (כמות מניות), PERIOD_DATE (תאריך), ו-QUARTER (רבעון).

**דוגמה פשוטה:**  
דמיין טבלה כמו רשימת קניות: "קרן A קנתה 100 מניות של אפל בשווי 10,000 דולר בתאריך 31/12/2017". אנחנו לוקחים את כל הרשימות הרבעוניות, מאחדים אותן, ומסירים טעויות כמו תאים ריקים.

**למה בחרנו בזה?**  
משתמשים ב-Pandas (ספרייה לטיפול בטבלאות) כי זה הכלי הסטנדרטי והפשוט ביותר לנתונים כאלה.

**יתרונות:** מהיר (מטפל באלפי שורות בשניות), גמיש (קל לשנות), מבטיח נתונים נקיים.

### שלב 2: בניית הגרף (Graph Construction)
**מה קורה כאן?**  
אנחנו הופכים את הנתונים ל"מפה" – גרף דו-צדדי. מצד אחד: קרנות, מצד שני: מניות. קשת מחברת קרן למניה אם הקרן מחזיקה בה. אחר כך, אנחנו יוצרים גרף של קרנות: אם שתי קרנות מחזיקות באותה מניה, יש ביניהן קשת.

**דוגמה פשוטה:**  
דמיין רשת חברתית: קרנות הן אנשים, מניות הן מסיבות. אם שתי קרנות היו באותה "מסיבה", הן מחוברות.

**למה זה חשוב למשקיעים:**  
"אנחנו בונים 'מפת קשרים' כמו בפייסבוק, כדי לזהות אילו קרנות 'מעתיקות' זו מזו. זה עוזר לחזות תנועות לפני שהשוק יודע".

### שלב 3: חילוץ מאפיינים (Feature Engineering)
**מה קורה כאן?**  
על הגרף, מחשבים "מאפיינים" לכל קרן: כמה חיבורים יש לה (Degree), כמה היא חשובה (PageRank, כמו בגוגל), לאיזו קבוצה היא שייכת (Communities).

**דוגמה פשוטה:**  
"כמה חברים יש לקרן?", "האם החברים שלה חשובים?", "לאיזו 'קבוצת חברים' היא שייכת?".

**למשקיעים:** "אנחנו מודדים 'מעמד חברתי' של כל קרן ברשת – מי הפופולרי, מי מוביל דעה – כדי להבין דפוסי השקעה".

### שלב 4: יצירת Embeddings (עם GraphSAGE)
**מה קורה כאן?**  
משתמשים ברשת נוירונים גרפית כדי ליצור "תעודת זהות מספרית" לכל קרן ומניה – וקטור מספרים שמייצג את המאפיינים והשכנים.

**למשקיעים:** "זה AI ש'לומד' את הרשת כמו שגוגל לומד את האינטרנט".

### שלב 5: אימון המודל (עם LightGBM)
**מה קורה כאן?**  
מאחדים את כל המידע ומאמנים מודל למידת מכונה שלומד מדפוסי עבר כדי לחזות עתיד.

**למשקיעים:** "המודל לומד מדפוסי עבר כדי לחזות עתיד – עם דיוק גבוה, בלי להסתכן בהטיות".

### שלב 6: הערכה וחיזוי
**מה קורה כאן?**  
בודקים את הדיוק על נתוני עבר (Q3), ואז חוזים לעתיד (Q4) עבור קרנות מוכרות.

---

## איך הנתונים הרבעוניים משולבים בפייפליין?

הנתונים מחולקים באופן **קשיח** לפי רבעונים, והחלוקה הזו משפיעה על כל השלבים:

| רבעון       | תפקיד בפייפליין                          | מה מותר ומה אסור                                              |
|--------------|--------------------------------------------|---------------------------------------------------------------------|
| Q1 + Q2 2018 | **תקופת אימון** | בניית הגרף, חישוב מאפיינים, אימון המודל |
| Q3 2018      | **בדיקת דיוק** | רק חיזוי וחישוב מטריקות - **אסור** לעדכן מודל |
| Q4 2018      | **חיזוי עתידי** | רק חיזוי על קרנות שכבר ראינו ב-Q1+Q2 |

### התחשבות בזמן ב-Link Prediction

יש **שתי רמות** של התחשבות בزמן:

#### 1. רמה גסה – חלוקה לפי רבעונים (הכי חשובה)
כל מה שנבנה/מאומן – נבנה **רק** על Q1+Q2. זה מבטיח **אפס דליפת מידע עתידי** – הכלל החשוב ביותר בחיזוי פיננסי.

#### 2. רמה עדינה – כיווניות קשתות
בתוך תקופת האימון (Q1+Q2), המערכת מזהה מי "הוביל" בהחזקות: אם קרן A התחילה להחזיק במניה לפני קרן B, הקשת מכוונת מ-A ל-B.

---

## סיכום למשקיעים

הפייפליין הזה נותן יתרון תחרותי משמעותי:
- **חיזוי מבוסס AI** עם דיוק גבוה
- **אפס דליפת נתונים** - תחזיות אמינות ובלתי מוטות  
- **זיהוי דפוסים נסתרים** ברשת הקרנות
- **יכולת לחזות מגמות** לפני שהשוק מזהה אותן

השקעה במערכת זו משמעותה השקעה בעתיד הפיננסים החכמים.

---

## זרימת עבודה למשתמש
1. **הכנת נתונים:** הנח את כל קובצי ה-CSV הרבעוניים בתיקיית העבודה. כל קובץ חייב לכלול: `CIK` (מזהה קרן), `CUSIP` (מזהה מניה), `VALUE`, `SSHPRNAMT`, `PERIOD_DATE`, `QUARTER`.
2. **הרצת הפייפליין:** פתח את ה-Jupyter notebook והרץ את כל התאים לפי הסדר. הפייפליין:
	- טוען ומנקה את הנתונים
	- בונה גרפים ומחלץ מאפיינים
	- מאמן את המודל (Q1-Q2)
	- מעריך על נתוני מדגם חיצוני (Q3)
	- מחזה לרבעון הבא (Q4)
3. **קבלת המליצות:** בתא האחרון, בחר קרן (מהקרנות הזכאות) וקבל המליצות מניות מובילות ל-Q4.

---

## הסבר מתמטי ואלגוריתמי

### 1. בניית גרף
הפייפליין מדמה את השוק כגרף דו-צדדי $G=(F, S, E)$ כאשר $F$ היא קבוצת הקרנות, $S$ היא קבוצת המניות, ו-$E$ הם קשתות המייצגות החזקות קרנות-מניות. גם נבנה גרף מקרין של קרנות-קרנות, כאשר קשתות מייצגות דמיון או החזקות משותפות בין קרנות.

### 2. הנדסת מאפיינים
לכל צומת (קרן או מניה), מחושבים המאפיינים הבאים:
- **דרגה:** $deg(v)$, מספר הקשתות לצומת $v$.
- **PageRank:** $PR(v)$, ציון חשיבות מאלגוריתם PageRank.
- **Hubs & Authorities:** מחושבים באמצעות אלגוריתם HITS.
- **קרבת מרכזיות:** $C(v) = \frac{1}{\sum_{u \neq v} d(u,v)}$
- **זיהוי קהילות:** באמצעות אלגוריתם Leiden להקצאת תוויות קהילה.

### 3. הטמעות צמתים (GraphSAGE)
GraphSAGE היא רשת נוירונים גרפית הלומדת ייצוגים דחוסים (embeddings) לכל צומת על ידי צבירת מאפיינים מהשכנים. לצומת $v$:
$$
h_v^{(k)} = \sigma \left( W^{(k)} \cdot \text{AGGREGATE}^{(k)} \left( \{ h_v^{(k-1)} \} \cup \{ h_u^{(k-1)}, \forall u \in N(v) \} \right) \right)
$$
כאשר $h_v^{(k)}$ היא ההטמעה בשכבה $k$, $N(v)$ הם השכנים, $W^{(k)}$ הם משקלים לימודיים, ו-$\sigma$ היא פונקציית אי-לינאריות.

### 4. אימון מודל (LightGBM)
וקטור המאפיינים הסופי לכל זוג (קרן, מניה) הוא שרשור של:
- מאפייני קרן
- מאפייני מניה
- הטמעת קרן
- הטמעת מניה

אלה משמשים לאימון מסווג LightGBM לחיזוי האם קרן תקנה מניה ברבעון הבא. המודל מאומן רק על נתוני Q1-Q2, עם דגימה שלילית לאיזון המערך.

### 5. הערכה וחיזוי
- **הערכה:** מתבצעת על Q3, רק עבור קרנות ומניות שנראו באימון. מדדים: AUC, דיוק, יחס חיובי/שלילי.
- **חיזוי:** עבור Q4, המודל ממליץ על מניות לקרנות זכאות (שנראו באימון ונוכחות ב-Q4), תוך הבטחת אי-דליפת נתונים/זמן.

---

## הערות מקצועיות על שלמות הנתונים
- **אין דליפת זמן:** כל המאפיינים וההטמעות לאימון נבנים באמצעות Q1-Q2 בלבד.
- **אין דליפת נתונים:** ההערכה מתבצעת רק על Q3, והחיזוי הוא ל-Q4 באמצעות קרנות זכאות בלבד.
- **אין דליפת תוויות:** המודל לעולם לא רואה נתוני עתיד במהלך האימון או בניית המאפיינים.

---

## דוגמת שימוש
```python
# ב-notebook, הגדר:
fund_id_to_predict = 'YOUR_FUND_CIK'  # למשל, '1325091'
# או השאר כ-None לבחירה אקראית
```
הרץ את תא החיזוי לקבלת המליצות המניות המובילות לקרן הנבחרת ב-Q4.

---

## חפצים ושחזור
כל המודלים המאומנים, ההטמעות והמאפיינים נשמרים בתיקייה `artifacts/` לטעינה מהירה ושחזור.

---

## דרישות מערכת
- Python 3.8+
- pandas, numpy, networkx, igraph, leidenalg
- torch, torch_geometric
- scikit-learn, lightgbm, joblib, pickle

---

## אודות
פרויקט זה פותח על ידי מדען נתונים מקצועי לשימוש אקדמי ומחקרי. לשאלות או שיתוף פעולה, אנא פנה למחבר.
