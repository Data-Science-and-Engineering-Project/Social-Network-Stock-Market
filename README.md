# 📈 רשת חברתית לשוק המניות - Stock Market Social Network

## מטרת הפרויקט
**יעד:** לחזות אילו מניות קרן השקעות עתידה לקנות ברבעון הבא, באמצעות למידת מכונה מתקדמת מבוססת גרפים. המערכת מיועדת לחיזוי חזק, בלתי מוטה ועל מדגם חיצוני, עם מניעה קפדנית של דליפת נתונים/זמן.

## מקור הנתונים - SEC 13F Reports
**מקור אמין ורשמי:** הנתונים מגיעים ממאגר SEC (Securities and Exchange Commission) האמריקאי, ספציפית מדוחות 13F. אלה דוחות חובה שכל קרן השקעה מוסדית בעלת נכסים מעל 100 מיליון דולר חייבת להגיש מידי רבעון. הנתונים מכסים את התקופה מ-2013 ועד היום, ומספקים תמונה מלאה וחסרת פערים של פעילות הקרנות המוסדיות בשוק המניות האמריקאי.

**מהימנות גבוהה:** מדובר בדיווח רשמי תחת פיקוח פדרלי, כולל עונשים כבדים על דיווח שקרי. זה מבטיח איכות נתונים יוצאת דופן ביחס למקורות מידע פיננסיים אחרים.

---

## הסבר ארוך ופשוט על הפייפליין: איך אנחנו חוזים השקעות עתידיות של קרנות בשוק המניות

שלום! אני הולך להסביר לך את הפייפליין בצורה ארוכה ומפורטת, אבל פשוטה מאוד, כאילו אני מסביר לחבר שמעולם לא ראה קוד. המטרה היא שתוכל להעביר את זה למשקיעים בצורה קלה, עם דוגמאות יומיומיות, כדי להראות איך המערכת עובדת, למה היא חכמה, ואיך היא נותנת יתרון תחרותי.

הפייפליין הזה הוא בעצם "מכונה" שמבוססת על בינה מלאכותית (AI) ולמידת מכונה (Machine Learning), שמנתחת נתוני השקעות מקרנות כדי לחזות אילו מניות הן יקנו ברבעון הבא. הרעיון המרכזי: שוק המניות הוא כמו רשת חברתית גדולה – קרנות "חברות" זו של זו אם הן מחזיקות במניות דומות, ואנחנו משתמשים בזה כדי לזהות דפוסים.

### שלב 1: הכנת הנתונים (Data Loading and Cleaning)
**מה קורה כאן?**  
אנחנו טוענים נתונים מקבצי CSV (כמו טבלאות Excel) שמכילים מידע על החזקות של קרנות השקעות בכל רבעון. כל קובץ כולל פרטים כמו: CIK (מזהה של הקרן), CUSIP (מזהה של המניה), VALUE (כמה כסף מושקע), SSHPRNAMT (כמות מניות), PERIOD_DATE (תאריך), ו-QUARTER (רבעון).

**דוגמה פשוטה:**  
דמיין טבלה כמו רשימת קניות: "קרן A קנתה 100 מניות של אפל בשווי 10,000 דולר בתאריך 31/12/2017". אנחנו לוקחים את כל הרשימות הרבעוניות, מאחדים אותן, ומסירים טעויות כמו תאים ריקים.

**למה בחרנו בזה?**  
משתמשים ב-Pandas (ספרייה לטיפול בטבלאות) כי זה הכלי הסטנדרטי והפשוט ביותר לנתונים כאלה.

**יתרונות:** מהיר (מטפל באלפי שורות בשניות), גמיש (קל לשנות), מבטיח נתונים נקיים.

### שלב 2: בניית הגרף (Graph Construction) - הסבר מעמיק
**מה קורה כאן בקוד?**  
כאן המערכת בונה שני סוגי גרפים במקביל:

**1. הגרף הדו-צדדי (Bipartite):**
- נבנה עם NetworkX: `nx.Graph()`
- צד אחד: צמתי קרנות (nodes מסוג 'fund')
- צד שני: צמתי מניות (nodes מסוג 'stock')
- קשתות: כל רשומה בדאטה הופכת לקשת, עם מאפיינים:
  - משקל לפי VALUE או SSHPRNAMT
  - תאריך (PERIOD_DATE)
  - מטא-דאטה נוסף

**2. הגרף המקרין (Fund-Fund Projected):**
```python
# פסאודו-קוד של האלגוריתם:
for fund1 in funds:
    for fund2 in funds:
        if fund1 != fund2:
            shared_stocks = מניות_משותפות(fund1, fund2)
            if len(shared_stocks) > threshold:
                weight = חישוב_דמיון(fund1, fund2, shared_stocks)
                G_projected.add_edge(fund1, fund2, weight=weight)
```

**3. הוספת כיווניות (Directionality):**
המערכת בודקת לכל זוג קרנות מי "התחיל קודם":
```python
avg_time_fund1 = ממוצע(תאריכי_החזקה[fund1])
avg_time_fund2 = ממוצע(תאריכי_החזקה[fund2])
if avg_time_fund1 < avg_time_fund2:
    כיוון_הקשת = fund1 -> fund2  # fund1 "השפיע" על fund2
```

**דוגמה מעשית מהקוד:**  
קרן BlackRock וקרן Vanguard שתיהן מחזיקות באפל, מיקרוסופט וגוגל. המערכת בודקת: מי התחיל להחזיק באפל קודם? אם BlackRock החלה ב-Q1 ו-Vanguard ב-Q2, הקשת תכוון מ-BlackRock ל-Vanguard.

**למה זה חשוב למשקיעים:**  
"אנחנו זוהים לא רק מי מחזיק במה, אלא גם מי 'מוביל' ומי 'עוקב'. זה יוצר מפת השפעות שמאפשרת לחזות: אם קרן מובילה קונה מניה חדשה, אילו קרנות 'עוקבות' יקנו אותה בהמשך".

### שלב 3: חילוץ מאפיינים (Feature Engineering) - הסבר מעמיק
**מה קורה כאן באלגוריתמים?**  
כאן המערכת מפעילה 5 אלגוריתמים מתקדמים על הגרף:

**1. חישוב Degree (פשוט אבל חשוב):**
```python
for node in G.nodes():
    degree[node] = G.degree(node)  # כמה קשרים יש לצומת
```
מה זה אומר: קרן עם Degree גבוה = מחזיקה במניות רבות או מחוברת לקרנות רבות

**2. PageRank (כמו באלגוריתם של גוגל):**
האלגוריתם רץ 100 איטרציות עם damping factor של 0.85:
```python
PR(v) = (1-d)/N + d * sum(PR(u)/L(u) for u pointing to v)
```
מה זה אומר במונחי קרנות: קרן "חשובה" אם היא מחוברת לקרנות חשובות אחרות

**3. HITS (Hubs & Authorities):**
אלגוריתם דו-שלבי:
- Authority Score: צומת טוב אם הוא מקבל קשרים מ-Hubs טובים
- Hub Score: צומת טוב אם הוא מצביע על Authorities טובות
בהקשר של קרנות: Authority = קרן שהרבה קרנות "מעתיקות" אותה

**4. Closeness Centrality:**
```python
CC(v) = (n-1) / sum(d(v,u) for u ≠ v)
```
מודד כמה "קרובה" קרן לכל שאר הקרנות ברשת. קרן עם ציון גבוה = יכולה להשפיע מהר על כל הרשת

**5. Community Detection עם Leiden:**
משתמש באלגוריתם Leiden (גרסה משופרת של Louvain) על iGraph:
```python
import leidenalg
partitions = leidenalg.find_partition(G_igraph, leidenalg.ModularityVertexPartition)
```
מוצא "קבוצות" של קרנות שמתנהגות דומה (למשל, קרנות טכנולוגיה, קרנות אנרגיה וכו')

**למה כל אלגוריתם חשוב:**
- **Degree:** זיהוי קרנות "פעילות" (מחזיקות הרבה מניות)
- **PageRank:** זיהוי קרנות "מכובדות" (מחוברות לקרנות חשובות)
- **HITS:** זיהוי מי "מוביל" (hub) ומי "נעקב" (authority)
- **Closeness:** זיהוי קרנות "מרכזיות" שיכולות להשפיע מהר
- **Communities:** זיהוי "שבטים" של קרנות עם אסטרטגיות דומות

**למשקיעים:** "אנחנו לא רק בודקים מי פופולרי - אנחנו מנתחים 5 ממדים שונים של השפעה: פעילות, מכובדות, מנהיגות, מרכזיות, ושיוך לקבוצות אסטרטגיות. זה נותן תמונה תלת-מימדית של כל קרן".

### שלב 4: יצירת Embeddings (עם GraphSAGE) - הסבר מעמיק
**מה קורה כאן בפועל?**  
כאן מתחיל החלק הכי מתקדם טכנולוגית - רשת נוירונים גרפית מיוחדת בשם GraphSAGE. בניגוד לרשתות נוירונים רגילות שעובדות על תמונות או טקסט, GraphSAGE מיועדת לעבוד על גרפים (רשתות קשרים). 

**איך זה עובד בקוד שלנו:**
1. **אתחול:** כל קרן ומניה מקבלת וקטור התחלתי (embedding) באורך 64 מספרים אקראיים
2. **שכבות עיבוד:** GraphSAGE רצה 2 שכבות (layers) שבהן:
   - כל צומת "מסתכל" על כל השכנים שלו
   - "אוסף" את המידע מהשכנים (aggregation) - בקוד שלנו: חישוב ממוצע
   - "מעדכן" את ה-embedding שלו על בסיס המידע החדש
3. **למידה:** המערכת מתאמנת על 1000 דוגמאות חיוביות (קרנות שקנו מניות) ו-1000 שליליות
4. **אופטימיזציה:** משתמש באלגוריתם Adam (קצב למידה 0.01) ל-200 אפוכות (epochs)

**למה GraphSAGE ולא משהו פשוט יותר?**
תחשבו על זה כך: קרן A "דומה" לקרן B לא רק בגלל המניות שהן מחזיקות, אלא גם בגלל הקרנות האחרות שמחזיקות באותן מניות! זה כמו להגיד שאתה דומה למישהו לא רק בגלל החברים המשותפים, אלא גם בגלל החברים של החברים. GraphSAGE לוכד את השכבות המרובות הללו של דמיון.

**למשקיעים:** "זה AI מתקדם שלומד דפוסים רב-שכבתיים - מי משפיע על מי, איך השפעות עוברות ברשת, ואיך לחזות התנהגויות על סמך 'חברים של חברים' ברשת הקרנות."

### שלב 5: אימון המודל (עם LightGBM) - הסבר מעמיק
**מה קורה כאן באלגוריתמים?**  
כאן מתחיל השלב הכי מורכב - בניית מודל החיזוי הסופי:

**1. בניית וקטורי מאפיינים (Feature Vectors):**
לכל זוג (קרן, מניה), המערכת יוצרת וקטור של 138 מאפיינים:
```python
feature_vector = [
    fund_degree, fund_pagerank, fund_hub, fund_authority, fund_closeness, fund_community,  # 6 מאפיינים
    stock_degree, stock_pagerank, stock_hub, stock_authority, stock_closeness, stock_community,  # 6 מאפיינים
    fund_embedding_64_dims,  # 64 מאפיינים מ-GraphSAGE
    stock_embedding_64_dims,  # 64 מאפיינים מ-GraphSAGE
]
```

**2. יצירת Labels (תוויות):**
```python
if (fund, stock) appeared in Q3_data:
    label = 1  # קרן קנתה את המניה
else:
    label = 0  # קרן לא קנתה את המניה
```

**3. Negative Sampling (איזון הדאטה):**
בעיה: יש הרבה יותר דוגמאות שליליות (קרנות שלא קנו מניות) מאשר חיוביות
פתרון: המערכת דוגמת אקראית דוגמאות שליליות עד שיש איזון 1:1

**4. LightGBM - למה בחרנו בזה?**
LightGBM הוא אלגוריתם Gradient Boosting מתקדם:
- **מהיר:** יכול לטפל במיליוני דוגמאות תוך דקות
- **חזק:** מטפל טוב בנתונים לא מאוזנים
- **אוטומטי:** בוחר אוטומטית אילו מאפיינים חשובים
- **גמיש:** עובד טוב עם מאפיינים מעורבים (מספרים רגילים + embeddings)

**5. היפר-פרמטרים שלנו:**
```python
lgb_params = {
    'objective': 'binary',  # חיזוי בינארי (קנה/לא קנה)
    'metric': 'auc',  # מטריקה לאופטימיזציה
    'boosting_type': 'gbdt',  # Gradient Boosting Decision Trees
    'num_leaves': 31,  # מורכבות של כל עץ
    'learning_rate': 0.1,  # קצב למידה
    'feature_fraction': 0.8  # כמה מאפיינים להשתמש בכל איטרציה
}
```

**6. תהליך האימון:**
המודל בונה 100 עצי החלטה זה אחר זה, כאשר כל עץ לומד מהטעויות של הקודמים

**למה זה עובד טוב למשקיעים?**
"LightGBM מצליח לזהות דפוסים מורכבים כמו: 'אם קרן היא authority גבוה, והיא מחזיקה במניות טכנולוגיה, והיא מקהילה 3, והיא מחוברת לקרן X שקנתה לאחרונה מניות Y - אז היא תקנה מניה Z ברבעון הבא'. זה סוג התחזית שאדם לא יכול לעשות, אבל AI כן".

### שלב 6: הערכה וחיזוי
**מה קורה כאן?**  
בודקים את הדיוק על נתוני עבר (Q3), ואז חוזים לעתיד (Q4) עבור קרנות מוכרות.

---

## איך הנתונים הרבעוניים משולבים בפייפליין?

הנתונים מחולקים באופן **קשיח** לפי רבעונים, והחלוקה הזו משפיעה על כל השלבים:

| רבעון       | תפקיד בפייפליין                          | מה מותר ומה אסור                                              |
|--------------|--------------------------------------------|---------------------------------------------------------------------|
| Q1 + Q2 2018 | **תקופת אימון** | בניית הגרף, חישוב מאפיינים, אימון המודל |
| Q3 2018      | **בדיקת דיוק** | רק חיזוי וחישוב מטריקות - **אסור** לעדכן מודל |
| Q4 2018      | **חיזוי עתידי** | רק חיזוי על קרנות שכבר ראינו ב-Q1+Q2 |

### התחשבות בזמן ב-Link Prediction

יש **שתי רמות** של התחשבות בزמן:

#### 1. רמה גסה – חלוקה לפי רבעונים (הכי חשובה)
כל מה שנבנה/מאומן – נבנה **רק** על Q1+Q2. זה מבטיח **אפס דליפת מידע עתידי** – הכלל החשוב ביותר בחיזוי פיננסי.

#### 2. רמה עדינה – כיווניות קשתות
בתוך תקופת האימון (Q1+Q2), המערכת מזהה מי "הוביל" בהחזקות: אם קרן A התחילה להחזיק במניה לפני קרן B, הקשת מכוונת מ-A ל-B.

---

## סיכום למשקיעים

הפייפליין הזה נותן יתרון תחרותי משמעותי:
- **חיזוי מבוסס AI** עם דיוק גבוה
- **אפס דליפת נתונים** - תחזיות אמינות ובלתי מוטות  
- **זיהוי דפוסים נסתרים** ברשת הקרנות
- **יכולת לחזות מגמות** לפני שהשוק מזהה אותן

השקעה במערכת זו משמעותה השקעה בעתיד הפיננסים החכמים.

---

## זרימת עבודה למשתמש
1. **הכנת נתונים:** הנח את כל קובצי ה-CSV הרבעוניים בתיקיית העבודה. כל קובץ חייב לכלול: `CIK` (מזהה קרן), `CUSIP` (מזהה מניה), `VALUE`, `SSHPRNAMT`, `PERIOD_DATE`, `QUARTER`.
2. **הרצת הפייפליין:** פתח את ה-Jupyter notebook והרץ את כל התאים לפי הסדר. הפייפליין:
	- טוען ומנקה את הנתונים
	- בונה גרפים ומחלץ מאפיינים
	- מאמן את המודל (Q1-Q2)
	- מעריך על נתוני מדגם חיצוני (Q3)
	- מחזה לרבעון הבא (Q4)
3. **קבלת המליצות:** בתא האחרון, בחר קרן (מהקרנות הזכאות) וקבל המליצות מניות מובילות ל-Q4.

---

## הסבר מתמטי ואלגוריתמי

### 1. בניית גרף
הפייפליין מדמה את השוק כגרף דו-צדדי $G=(F, S, E)$ כאשר $F$ היא קבוצת הקרנות, $S$ היא קבוצת המניות, ו-$E$ הם קשתות המייצגות החזקות קרנות-מניות. גם נבנה גרף מקרין של קרנות-קרנות, כאשר קשתות מייצגות דמיון או החזקות משותפות בין קרנות.

### 2. הנדסת מאפיינים
לכל צומת (קרן או מניה), מחושבים המאפיינים הבאים:
- **דרגה:** $deg(v)$, מספר הקשתות לצומת $v$.
- **PageRank:** $PR(v)$, ציון חשיבות מאלגוריתם PageRank.
- **Hubs & Authorities:** מחושבים באמצעות אלגוריתם HITS.
- **קרבת מרכזיות:** $C(v) = \frac{1}{\sum_{u \neq v} d(u,v)}$
- **זיהוי קהילות:** באמצעות אלגוריתם Leiden להקצאת תוויות קהילה.

### 3. הטמעות צמתים (GraphSAGE)
GraphSAGE היא רשת נוירונים גרפית הלומדת ייצוגים דחוסים (embeddings) לכל צומת על ידי צבירת מאפיינים מהשכנים. לצומת $v$:

$$h_v^{(k)} = \sigma \left( W^{(k)} \cdot \text{AGGREGATE}^{(k)} \left( \{ h_v^{(k-1)} \} \cup \{ h_u^{(k-1)}, \forall u \in N(v) \} \right) \right)$$

כאשר $h_v^{(k)}$ היא ההטמעה בשכבה $k$, $N(v)$ הם השכנים, $W^{(k)}$ הם משקלים לימודיים, ו-$\sigma$ היא פונקציית אי-לינאריות.

### 4. אימון מודל (LightGBM)
וקטור המאפיינים הסופי לכל זוג (קרן, מניה) הוא שרשור של:
- מאפייני קרן
- מאפייני מניה
- הטמעת קרן
- הטמעת מניה

אלה משמשים לאימון מסווג LightGBM לחיזוי האם קרן תקנה מניה ברבעון הבא. המודל מאומן רק על נתוני Q1-Q2, עם דגימה שלילית לאיזון המערך.

### 5. הערכה וחיזוי
- **הערכה:** מתבצעת על Q3, רק עבור קרנות ומניות שנראו באימון. מדדים: AUC, דיוק, יחס חיובי/שלילי.
- **חיזוי:** עבור Q4, המודל ממליץ על מניות לקרנות זכאות (שנראו באימון ונוכחות ב-Q4), תוך הבטחת אי-דליפת נתונים/זמן.

---

## הערות מקצועיות על שלמות הנתונים
- **אין דליפת זמן:** כל המאפיינים וההטמעות לאימון נבנים באמצעות Q1-Q2 בלבד.
- **אין דליפת נתונים:** ההערכה מתבצעת רק על Q3, והחיזוי הוא ל-Q4 באמצעות קרנות זכאות בלבד.
- **אין דליפת תוויות:** המודל לעולם לא רואה נתוני עתיד במהלך האימון או בניית המאפיינים.

---

## דוגמת שימוש
```python
# ב-notebook, הגדר:
fund_id_to_predict = 'YOUR_FUND_CIK'  # למשל, '1325091'
# או השאר כ-None לבחירה אקראית
```
הרץ את תא החיזוי לקבלת המליצות המניות המובילות לקרן הנבחרת ב-Q4.

---

## חפצים ושחזור
כל המודלים המאומנים, ההטמעות והמאפיינים נשמרים בתיקייה `artifacts/` לטעינה מהירה ושחזור.

---

## דרישות מערכת
- Python 3.8+
- pandas, numpy, networkx, igraph, leidenalg
- torch, torch_geometric
- scikit-learn, lightgbm, joblib, pickle

---
